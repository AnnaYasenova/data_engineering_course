CREATE EXTERNAL SCHEMA spectrum_schema
FROM DATA CATALOG
DATABASE 'anna-dp_database'
IAM_ROLE 'arn:aws:iam::827992710155:role/anna-dp-redshift-service-role'
CREATE EXTERNAL DATABASE IF NOT EXISTS;

SELECT schemaname, tablename
FROM svv_external_tables;

CREATE SCHEMA IF NOT EXISTS gold;

CREATE TABLE IF NOT EXISTS gold.user_profiles_enriched (
    client_id INT,
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    email VARCHAR(255),
    registration_date DATE,
    state VARCHAR(100),
    birth_date DATE,
    phone_number VARCHAR(50)
);
SELECT *
FROM spectrum_schema.customers
LIMIT 5;

MERGE INTO gold.user_profiles_enriched
USING (
    SELECT
        c.id as client_id,
        COALESCE(c.firstname, SPLIT_PART(u.full_name, ' ', 1)) AS first_name,
        COALESCE(c.lastname, SPLIT_PART(u.full_name, ' ', 2)) AS last_name,
        COALESCE(c.state, u.state) AS state,
        c.email,
        CAST(c.registrationdate AS DATE) as registration_date,
        CAST(u.birth_date AS DATE) as birth_date,
        u.phone_number
    FROM spectrum_schema.customers c
    LEFT JOIN spectrum_schema.user_profiles u
        ON c.email = u.email
) source
ON gold.user_profiles_enriched.client_id = source.client_id

WHEN MATCHED THEN
UPDATE SET
    first_name = source.first_name,
    last_name = source.last_name,
    state = source.state,
    birth_date = source.birth_date,
    phone_number = source.phone_number

WHEN NOT MATCHED THEN
INSERT (
    client_id, first_name, last_name, email,
    registration_date, state, birth_date, phone_number
)
VALUES (
    source.client_id, source.first_name, source.last_name,
    source.email, source.registration_date,
    source.state, source.birth_date, source.phone_number
);
